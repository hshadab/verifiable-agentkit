<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novanet - Verifiable Agent Kit</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />
    
    <style>
        /* --- COMPLETE AND CORRECTED CSS --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #000000; color: #ffffff; height: 100vh; display: flex; overflow: hidden; }
        .sidebar { width: 280px; background: #111111; padding: 24px; overflow-y: auto; border-right: 1px solid rgba(107, 124, 255, 0.3); }
        .sidebar h3 { background: linear-gradient(135deg, #6B7CFF 0%, #4A5A8A 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 12px; text-transform: uppercase; font-size: 13px; letter-spacing: 0.1em; font-weight: 700; }
        .info-box { font-size: 11px; color: #a0a0a0; margin-bottom: 24px; padding: 12px; background: rgba(107, 124, 255, 0.08); border: 1px solid rgba(107, 124, 255, 0.2); border-radius: 8px; line-height: 1.6; }
        .example-category { margin-bottom: 28px; }
        .example-category h4 { color: #8B9AFF; font-size: 11px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.1em; font-weight: 600; }
        .example-item { word-wrap: break-word; overflow-wrap: break-word; white-space: normal; width: 100%; box-sizing: border-box; background: rgba(107, 124, 255, 0.05); border: 1px solid rgba(107, 124, 255, 0.15); padding: 14px 18px; margin-bottom: 8px; border-radius: 10px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); font-size: 13px; color: #ffffff; }
        .example-item:hover { background: rgba(107, 124, 255, 0.15); border-color: rgba(107, 124, 255, 0.4); transform: translateX(4px); }
        .main-container { flex: 1; display: flex; flex-direction: column; background: #000000; }
        .header { padding: 20px 32px; background: rgba(17, 17, 17, 0.8); border-bottom: 1px solid rgba(107, 124, 255, 0.2); display: flex; align-items: center; justify-content: space-between; backdrop-filter: blur(10px); }
        .header h1 { font-size: 26px; font-weight: 700; display: flex; align-items: center; gap: 12px; }
        .header h1 span { background: linear-gradient(135deg, #6B7CFF 0%, #4A5A8A 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .status { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 24px; font-size: 13px; }
        .status.connected { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); }
        .status.disconnected { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status.connected .status-dot { background-color: #10b981; animation: pulse 2s infinite; }
        .status.disconnected .status-dot { background-color: #ef4444; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .messages-container { flex: 1; overflow-y: auto; padding: 32px; }
        #messages { max-width: 1000px; margin: 0 auto; }
        .message { margin: 24px 0; display: flex; align-items: flex-start; gap: 12px; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.assistant { flex-direction: row-reverse; }
        .message-content { max-width: 70%; padding: 16px 24px; border-radius: 20px; line-height: 1.6; font-size: 15px; }
        .message.user .message-content { background: #1e1e1e; border: 1px solid rgba(107, 124, 255, 0.2); border-bottom-left-radius: 4px; white-space: pre-wrap; }
        .message.assistant .message-content { background: linear-gradient(135deg, #6B7CFF 0%, #4A5A8A 100%); color: white; border-bottom-right-radius: 4px; }
        
        /* Animated ellipsis for waiting state */
        .message.waiting .message-content::after {
            content: '';
            animation: ellipsis 1.5s infinite;
        }
        @keyframes ellipsis {
            0% { content: ''; }
            25% { content: '.'; }
            50% { content: '..'; }
            75% { content: '...'; }
        }
        
        .proof-card, .transaction-card, .verification-card { margin-left: auto; margin-right: 0; background: rgba(30, 30, 30, 0.9); border: 1px solid rgba(107, 124, 255, 0.3); border-radius: 16px; padding: 24px; margin: 20px 0; max-width: 800px; }
        .message.user .proof-card, .message.user .transaction-card, .message.user .verification-card { margin-right: auto; margin-left: 0; }
        .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .card-title { font-size: 18px; font-weight: 700; color: #c4b5fd; }
        .card-actions { display: flex; gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(107, 124, 255, 0.1); flex-wrap: wrap; }
        .action-btn { background: rgba(107, 124, 255, 0.15); color: #a78bfa; border: 1px solid rgba(107, 124, 255, 0.2); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; }
        .action-btn:hover { background: rgba(107, 124, 255, 0.25); border-color: #8B9AFF; color: #c4b5fd; transform: translateY(-1px); }
        .input-container { padding: 24px 32px; background: rgba(17, 17, 17, 0.9); border-top: 1px solid rgba(107, 124, 255, 0.2); }
        .input-wrapper { max-width: 1000px; margin: 0 auto; display: flex; gap: 16px; align-items: center; }
        #user-input { flex: 1; padding: 18px 28px; background: rgba(0, 0, 0, 0.6); border: 2px solid rgba(107, 124, 255, 0.3); border-radius: 30px; color: #ffffff; font-size: 16px; outline: none; }
        #user-input:focus { border-color: #8B9AFF; }
        #send-button { padding: 18px 36px; background: linear-gradient(135deg, #6B7CFF 0%, #4A5A8A 100%); color: white; border: none; border-radius: 30px; font-size: 16px; font-weight: 700; cursor: pointer; }
        #upload-button, #paste-button { padding: 18px 20px; background: rgba(107, 124, 255, 0.2); color: #a78bfa; border: 2px solid rgba(107, 124, 255, 0.3); border-radius: 30px; font-size: 20px; cursor: pointer; }
        .paste-container { display: none; flex-direction: column; position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 800px; background: #111; border: 2px solid #6B7CFF; border-radius: 20px; padding: 20px; z-index: 1000; box-shadow: 0 -5px 30px rgba(0,0,0,0.5); }
        .paste-header { display:flex; justify-content: space-between; align-items:center; margin-bottom: 15px;}
        .paste-header h3 { color: #8B9AFF; margin:0;}
        .close-btn { background:none; border:none; color:#666; font-size:24px; cursor:pointer;}
        .code-editor-wrapper { position: relative; height: 300px; margin-bottom: 15px; }
        #code-paste-wrapper { width: 100%; height: 100%; position: relative; background: #0d0d0d; border: 1px solid #444; border-radius: 8px; overflow: hidden; }
        #code-paste { width: 100%; height: 100%; background: transparent; color: white; border: none; padding: 15px 15px 15px 50px; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 13px; resize: none; outline: none; line-height: 1.5; overflow-y: auto; }
        .line-numbers { position: absolute; left: 0; top: 0; width: 40px; height: 100%; background: #1a1a1a; border-right: 1px solid #333; padding: 15px 5px; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 13px; line-height: 1.5; color: #666; text-align: right; user-select: none; overflow: hidden; }
        .paste-actions { display:flex; justify-content: flex-end; gap: 10px;}
        .paste-actions button { padding: 8px 16px; border-radius: 8px; border: 1px solid #6B7CFF; background: transparent; color: #6B7CFF; cursor: pointer; }
        .paste-actions button.primary { background: #6B7CFF; color: white;}
        
        /* Progress Steps for Automated Flow */
        .progress-steps { display: flex; gap: 20px; margin-top: 16px; }
        .step { padding: 8px 16px; background: rgba(107, 124, 255, 0.1); border: 1px solid rgba(107, 124, 255, 0.2); border-radius: 20px; font-size: 13px; color: #666; transition: all 0.3s ease; }
        .step.active { background: rgba(107, 124, 255, 0.2); border-color: #6B7CFF; color: #8B9AFF; animation: pulse 2s infinite; }
        .step.complete { background: rgba(16, 185, 129, 0.15); border-color: rgba(16, 185, 129, 0.3); color: #10b981; }
        
        /* Status Badge */
        .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .status-badge.generating { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .status-badge.complete { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .status-badge.error { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .status-badge.verifying { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .status-badge.verified { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        
        /* Status Indicator for Cards */
        .status-indicator { display: flex; align-items: center; gap: 8px; }
        .card-content { margin-top: 16px; }
        .status-message { color: #a0a0a0; font-size: 13px; line-height: 1.6; }
        
        /* Proof Metrics */
        .proof-metrics { display: flex; gap: 24px; margin-top: 16px; padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; }
        .metric { display: flex; align-items: center; gap: 8px; }
        .metric-label { color: #666; font-size: 13px; }
        .metric-value { color: #8B9AFF; font-weight: 600; }
        
        /* Inline code display */
        .inline-code-display { margin-top: 20px; }
        
        /* History Table Styles */
        .history-table-container { margin-top: 20px; background: rgba(30, 30, 30, 0.9); border: 1px solid rgba(107, 124, 255, 0.3); border-radius: 16px; padding: 24px; overflow-x: auto; }
        .history-table { width: 100%; border-collapse: collapse; }
        .history-table th { background: rgba(107, 124, 255, 0.1); color: #8B9AFF; padding: 12px; text-align: left; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 2px solid rgba(107, 124, 255, 0.3); }
        .history-table td { padding: 12px; border-bottom: 1px solid rgba(107, 124, 255, 0.1); color: #a0a0a0; font-size: 13px; }
        .history-table tr:hover { background: rgba(107, 124, 255, 0.05); }
        .history-table .proof-id { color: #8B9AFF; font-family: monospace; font-size: 13px; }
        .history-table .function-badge { display: inline-block; padding: 3px 8px; background: rgba(107, 124, 255, 0.2); color: #a78bfa; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .history-table .timestamp { color: #666; font-size: 13px; }
        .history-table .action-link { color: #8B9AFF; text-decoration: none; cursor: pointer; font-weight: 500; }
        .history-table .action-link:hover { text-decoration: underline; }
        
        /* Update history table styles for better column widths */
        .history-table th:first-child,
        .history-table td:first-child {
            width: 20%; /* Function column */
        }
        
        .history-table th:nth-child(2),
        .history-table td:nth-child(2) {
            width: 45%; /* Proof ID column */
        }
        
        .history-table th:nth-child(3),
        .history-table td:nth-child(3) {
            width: 25%; /* Timestamp column */
        }
        
        .history-table th:nth-child(4),
        .history-table td:nth-child(4) {
            width: 10%; /* Actions column (only in Proof History) */
            text-align: center;
        }
        
        /* Ensure function badges are properly styled */
        .history-table .function-badge {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(107, 124, 255, 0.2);
            color: #a78bfa;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        
        /* Style for verified status in Actions column */
        .history-table td:last-child {
            font-weight: 500;
        }
        
        /* Debug console */
        .debug-console { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.9); border: 1px solid #333; border-radius: 8px; padding: 10px; font-family: monospace; font-size: 11px; color: #0f0; max-width: 300px; z-index: 10000; }
        .debug-console.minimized { height: 30px; overflow: hidden; }
        .debug-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; }
        .debug-messages { max-height: 200px; overflow-y: auto; margin-top: 5px; }
        .debug-console.minimized .debug-messages { display: none; }
        
        /* Syntax highlighted code in paste area */
        pre[class*="language-"] { margin: 0; background: transparent; }
        .code-editor-wrapper pre { padding: 15px 15px 15px 50px !important; }
        .code-editor-wrapper .line-numbers-rows { left: 0 !important; top: 15px !important; }
        
        
        .demo-notice h2 {
            color: #8B9AFF;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .demo-notice p {
            color: #a0a0a0;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .demo-notice button {
            background: linear-gradient(135deg, #6B7CFF 0%, #4A5A8A 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
        }
        
        /* Explorer link styles */
        .explorer-link {
            color: #4a90e2 !important;
            text-decoration: underline !important;
            cursor: pointer !important;
        }
        
        .explorer-link:hover {
            color: #357abd !important;
            text-decoration: underline !important;
        }
        
        .transfer-status a {
            color: #4a90e2 !important;
            text-decoration: underline !important;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3>SAMPLE PROMPTS</h3>
        
        <div class="example-category">
            <div class="example-item" data-example="Prove AI content authenticity">Prove AI content authenticity</div>
            <div class="example-item" data-example="Prove location: NYC (40.7°, -74.0°)">Prove location: NYC (40.7°, -74.0°)</div>
        </div>

        <div class="example-category">
            <div class="example-item" data-example="Send 0.1 USDC to Alice on Ethereum if KYC compliant">Send 0.1 USDC to Alice on Ethereum if KYC compliant</div>
            <div class="example-item" data-example="Send 0.1 USDC to Alice on Solana if KYC compliant">Send 0.1 USDC to Alice on Solana if KYC compliant</div>
        </div>

        <div class="example-category">
            <h4>Proof Management</h4>
            <div class="example-item" data-example="Proof History">Proof History</div>
            <div class="example-item" data-example="Verification History">Verification History</div>
        </div>
    </div>
    
    <div class="main-container">
        <div class="header">
            <h1 style="display: flex; align-items: center; gap: 12px;">
                <img src="https://cdn.prod.website-files.com/65d52b07d5bc41614daa723f/665df12739c532f45b665fe7_logo-novanet.svg" alt="Novanet" style="height: 32px;">
                <span>Verifiable Agent Kit</span>
            </h1>
            <div class="status" id="status-indicator">
                <div class="status-dot"></div>
                <span id="connection-status">Connecting...</span>
            </div>
        </div>
        
        <div class="messages-container"><div id="messages"></div></div>
        
        <div class="input-container">
            <div class="input-wrapper">
                <input type="file" id="file-upload" accept=".c" style="display: none;" onchange="handleFileUpload(event)">
                <button id="upload-button" onclick="document.getElementById('file-upload').click()" title="Upload C file">📤</button>
                <button id="paste-button" onclick="togglePasteArea()" title="Paste C code">📋</button>
                <input type="text" id="user-input" placeholder="Ask me to prove a computation..." autofocus>
                <button id="send-button">Send</button>
            </div>
        </div>
    </div>

    <div id="paste-area" class="paste-container">
        <div class="paste-header">
            <h3>Paste C Code</h3>
            <button class="close-btn" onclick="togglePasteArea()">×</button>
        </div>
        <div class="code-editor-wrapper">
            <div id="code-paste-wrapper">
                <div class="line-numbers" id="line-numbers">1</div>
                <textarea id="code-paste" placeholder="// Your C code with a main() function..." oninput="updateLineNumbers()"></textarea>
            </div>
        </div>
        <div style="margin-bottom:15px; font-size:13px;">
            <span style="color: #a0a0a0;">Examples:</span>
            <button class="action-btn" onclick="loadPasteExample('simple')">Prime Check</button>
            <button class="action-btn" onclick="loadPasteExample('range')">Collatz</button>
            <button class="action-btn" onclick="loadPasteExample('hash')">Digital Root</button>
        </div>
        <div class="paste-actions">
            <button onclick="togglePasteArea()">Cancel</button>
            <button class="primary" onclick="processCodePaste()">Prepare Code</button>
        </div>
    </div>
    
    <div id="debug-console" class="debug-console" style="display:none;">
        <div class="debug-header" onclick="toggleDebugMinimize()">
            <div style="color:#ff0;">DEBUG CONSOLE</div>
            <div id="debug-toggle" style="color:#0f0;">▼</div>
        </div>
        <div id="debug-messages" class="debug-messages"></div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-wasm.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>

    <script>
        // --- COMPLETE FRONTEND WITH REAL CIRCLE TRANSFER SUPPORT ---

        let ws = null;
        const proofStates = {};
        const activeCards = {};
        let debugMode = true; // Enable debug mode
        let debugMinimized = false;
        const verificationTimes = {}; // Store verification start times
        let waitingMessageId = null; // Track waiting message
        const activePolls = {}; // Store active polling intervals
        
        // Toggle debug console minimize state
        function toggleDebugMinimize() {
            const console = document.getElementById('debug-console');
            const toggle = document.getElementById('debug-toggle');
            debugMinimized = !debugMinimized;
            if (debugMinimized) {
                console.classList.add('minimized');
                toggle.textContent = '▲';
            } else {
                console.classList.remove('minimized');
                toggle.textContent = '▼';
            }
        }
        
        // Debug logging
        function debug(message) {
            console.log(`[ZKP Agent] ${message}`);
            if (debugMode) {
                const debugDiv = document.getElementById('debug-console');
                const messagesDiv = document.getElementById('debug-messages');
                debugDiv.style.display = 'block';
                const time = new Date().toLocaleTimeString();
                messagesDiv.innerHTML += `<div>[${time}] ${message}</div>`;
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }


        // Function to show rate limit message
        function showRateLimitMessage(proofId) {
            const card = activeCards[proofId];
            if (!card) return;
            
            const content = card.querySelector('.card-content');
            if (content) {
                const rateLimitHtml = `
                    <div style="margin-top: 20px; padding: 16px; background: rgba(251, 191, 36, 0.1); border-radius: 8px;">
                        <div style="font-weight: 600; color: #fbbf24; margin-bottom: 8px;">⏸️ Rate Limit Reached</div>
                        <div style="font-size: 13px; color: #a0a0a0;">
                            <div>Circle API rate limit exceeded. This is normal when checking multiple transfers.</div>
                            <div style="margin-top: 8px;">The transfer is still processing. Please wait a moment and check back.</div>
                            <div style="margin-top: 8px; font-size: 12px; color: #666;">
                                Tip: Circle processes transfers within 1-2 minutes. You can check your transaction history later.
                            </div>
                        </div>
                    </div>
                `;
                content.innerHTML += rateLimitHtml;
            }
        }


        function addMessage(html, sender) {
            const messages = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${sender}`;
            const contentEl = document.createElement('div');
            contentEl.className = 'message-content';
            contentEl.innerHTML = html.replace(/\n/g, '<br>');
            messageEl.appendChild(contentEl);
            messages.appendChild(messageEl);
            messages.scrollTop = messages.scrollHeight;

            // Store card reference for polling updates
            // activeCards[transferId] = document.getElementById(`card-${transferId}`);
            // Removed: transferId not defined in addMessage
            return messageEl;
        }
        
        function addWaitingMessage() {
            removeWaitingMessage(); // Remove any existing waiting message
            const messages = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message assistant waiting';
            messageEl.id = 'waiting-message';
            const contentEl = document.createElement('div');
            contentEl.className = 'message-content';
            contentEl.innerHTML = 'Thinking';
            messageEl.appendChild(contentEl);
            messages.appendChild(messageEl);
            messages.scrollTop = messages.scrollHeight;
            waitingMessageId = 'waiting-message';
        }
        
        function removeWaitingMessage() {
            if (waitingMessageId) {
                const waitingEl = document.getElementById(waitingMessageId);
                if (waitingEl) {
                    waitingEl.remove();
                }
                waitingMessageId = null;
            }
        }

        function sendMessage(messageText = null) {
            const input = document.getElementById('user-input');
            const message = messageText || input.value.trim();
            if (!message) return;
            
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                debug('WebSocket not connected, attempting to reconnect...');
                addMessage('⚠️ Connection lost. Attempting to reconnect...', 'assistant');
                connect();
                return;
            }
            
            addMessage(message, 'user');
            addWaitingMessage(); // Show waiting animation
            
            debug(`Sending message: ${message}`);
            ws.send(JSON.stringify({ message: message }));
            if (!messageText) input.value = '';
        }

        function connect() {
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('connection-status');
            
            debug('Attempting WebSocket connection to ws://localhost:8001/ws');
            
            try {
                ws = new WebSocket('ws://localhost:8001/ws');

                ws.onopen = () => {
                    debug('WebSocket connected successfully');
                    statusText.textContent = 'Connected';
                    statusIndicator.className = 'status connected';
                    
                    // Send a test message
                    setTimeout(() => {
                        if (ws.readyState === WebSocket.OPEN) {
                            debug('Connection stable');
                        }
                    }, 1000);
                };

                ws.onmessage = (event) => {
                    debug(`Received: ${event.data.substring(0, 100)}...`);
                    try {
                        const data = JSON.parse(event.data);
                        handleMessage(data);
                    } catch (e) { 
                        debug(`JSON Parse Error: ${e.message}`);
                        console.error('JSON Parse Error:', event.data, e); 
                    }
                };

                ws.onclose = (event) => {
                    debug(`WebSocket closed: Code ${event.code}, Reason: ${event.reason}`);
                    statusText.textContent = 'Disconnected';
                    statusIndicator.className = 'status disconnected';
                    
                    // Reconnect after 3 seconds
                    setTimeout(() => {
                        debug('Attempting reconnection...');
                        connect();
                    }, 3000);
                };
                
                ws.onerror = (error) => {
                    debug(`WebSocket error: ${error.message || 'Unknown error'}`);
                    console.error('WebSocket Error:', error);
                    statusText.textContent = 'Error';
                    statusIndicator.className = 'status disconnected';
                };
                
            } catch (e) {
                debug(`Failed to create WebSocket: ${e.message}`);
                statusText.textContent = 'Connection Failed';
                statusIndicator.className = 'status disconnected';
            }
        }

        // Enhanced message handler
        function handleMessage(data) {
            debug(`Handling message type: ${data.type || 'unknown'}`);
            
            // Remove waiting message when we get a response
            if (data.type === 'chat_response' || data.type === 'error') {
                removeWaitingMessage();
            }
            
            switch(data.type) {
                case 'chat_response':
                    handleChatResponse(data);
                    break;
                case 'proof_status':
                    updateProofStatus(data);
                    break;
                case 'proof_complete':
                    handleProofComplete(data);
                    break;
                case 'proof_error':
                    handleProofError(data);
                    break;
                case 'verification_status':
                    updateVerificationStatus(data);
                    break;
                case 'verification_complete':
                    handleVerificationComplete(data);
                    break;
                case 'transfer_status':
                    updateTransferStatus(data);
                    break;
                case 'transfer_complete':
                    handleTransferComplete(data);
                    break;
                case 'transfer_error':
                    handleTransferError(data);
                    break;
                case 'list_response':
                    handleListResponse(data);
                    break;
                case 'error':
                    addMessage(data.response || 'An error occurred', 'assistant');
                    break;
                default:
                    // Handle verification requests
                    if (data.metadata && data.metadata.type === 'verification_request') {
                        sendMessage(`verify proof ${data.metadata.proof_id}`);
                    } else if (data.response) {
                        addMessage(data.response, 'assistant');
                    }
            }
        }

        function handleChatResponse(data) {
            // Only add the message if it's not a custom proof (which already added its own clean message)
            if (!data.metadata || data.metadata.type !== 'custom_proof') {
                addMessage(data.response, 'assistant');
            } else {
                // For custom proofs, still show the AI response but not the encoded message
                addMessage(data.response, 'assistant');
            }
            
            // Check if this is starting an automated transfer
            if (data.metadata && data.metadata.is_automated_transfer) {
                // Extract transfer details
                const transferDetails = data.metadata.transfer_details || {};
                createTransactionCard(data.metadata.proof_id, transferDetails);
            }
            
            // Handle direct transfers
            if (data.metadata && data.metadata.type === 'direct_transfer') {
                // For direct transfers, execute immediately without proof
                handleDirectTransfer(data);
            }
            
            // Handle verification requests
            if (data.metadata && data.metadata.type === 'verification_request') {
                // The Rust server should handle the actual verification
                debug(`Verification requested for ${data.metadata.proof_id}`);
            }
        }
        
        async function handleDirectTransfer(data) {
            const transferDetails = data.metadata.transfer_details || {};
            const transferId = `transfer_${Date.now()}`;
            
            // Store the card ID for later updates
            activeCards[transferId] = null; // Will be set after creating the card
            
            const cardHtml = `
                <div class="transaction-card" id="card-${transferId}">
                    <div class="card-header">
                        <div class="card-title">💸 Direct USDC Transfer</div>
                        <div class="status-indicator">
                            <span class="status-dot" style="background: #fbbf24; animation: pulse 2s infinite;"></span>
                            <span class="status-text">Processing...</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="status-message">Executing direct USDC transfer...</div>
                        <div style="margin-top: 12px; padding: 12px; background: rgba(107, 124, 255, 0.1); border-radius: 8px; font-size: 13px;">
                            <div style="color: #8B9AFF; margin-bottom: 4px;">Transfer Details:</div>
                            <div style="color: #a0a0a0;">From: ${transferDetails.blockchain === "SOL" ? "HsZdbBxZVNzEn4qR9Ebx5XxDSZ136Mu14VlH1nbXGhfG" : "0x82a26a6d847e7e0961ab432b9a5a209e0db41040"} (Circle Wallet)</div>
                            <div style="color: #a0a0a0;">To: ${transferDetails.recipient ? transferDetails.recipient.slice(0,10) + '...' + transferDetails.recipient.slice(-8) : '0x70997970...17dc79C8'}</div>
                            <div style="color: #a0a0a0;">Blockchain: ${transferDetails.blockchain === "SOL" ? "Solana Devnet" : "Ethereum Sepolia"}</div>
                            <div style="color: #a0a0a0;">Amount: ${transferDetails.amount || '0.1'} USDC</div>
                            <div style="color: #a0a0a0; margin-top: 8px; font-style: italic;">No KYC verification required</div>
                        </div>
                        <div id="transfer-result-${transferId}"></div>
                    </div>
                </div>
            `;
            
            const messages = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message assistant';
            messageEl.innerHTML = cardHtml;
            messages.appendChild(messageEl);
            messages.scrollTop = messages.scrollHeight;
            
            // Store reference to the card
            activeCards[transferId] = document.getElementById(`card-${transferId}`);
            
            // Execute the transfer via backend
            try {
                const response = await fetch('http://localhost:8002/execute_direct_transfer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ transfer_details: transferDetails })
                });
                
                debug(`Direct transfer response status: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    debug(`Direct transfer error response: ${errorText}`);
                    
                    let errorMessage = 'Transfer request failed';
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.detail || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                debug(`Direct transfer result: ${JSON.stringify(result)}`);
                
                // Update the card with success
                const card = document.getElementById(`card-${transferId}`);
                if (card) {
                    const statusDot = card.querySelector('.status-dot');
                    const statusText = card.querySelector('.status-text');
                    const statusMessage = card.querySelector('.status-message');
                    const resultDiv = document.getElementById(`transfer-result-${transferId}`);
                    
                    if (statusDot) statusDot.style.background = '#10b981';
                    if (statusText) {
                        statusText.textContent = 'Complete';
                        statusText.style.color = '#10b981';
                    }
                    if (statusMessage) {
                        statusMessage.textContent = 'Transfer initiated successfully!';
                        statusMessage.style.color = '#10b981';
                    }
                    
                    // Get the transaction hash
                    const txHash = result.transactionHash || result.txHash || result.hash || result.transactionId;
                    const circleTransferId = result.circleTransferId || result.transferId;
                    
                    let explorerUrl = '';
                    let explorerName = '';
                    
                    if (txHash && txHash !== 'pending') {
                        if (transferDetails.blockchain === "SOL") {
                            explorerUrl = `https://explorer.solana.com/tx/${txHash}?cluster=devnet`;
                            explorerName = 'Solana Explorer';
                        } else {
                            explorerUrl = `https://sepolia.etherscan.io/tx/${txHash}`;
                            explorerName = 'Sepolia Etherscan';
                        }
                    }
                    
                    const detailsHtml = `
                        <div style="margin-top: 20px; padding: 16px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                            <div style="font-weight: 600; color: #10b981; margin-bottom: 8px;">✅ Transfer Initiated!</div>
                            <div style="font-size: 13px; color: #a0a0a0;">
                                <div>Amount: ${result.amount || transferDetails.amount || '0.1'} USDC</div>
                                <div>From: ${result.from || (transferDetails.blockchain === "SOL" ? "HsZdbBxZVNzEn4qR9Ebx5XxDSZ136Mu14VlH1nbXGhfG" : "0x82a26a6d847e7e0961ab432b9a5a209e0db41040")}</div>
                                <div>To: ${result.recipient || transferDetails.recipient || 'Unknown'}</div>
                                <div>Blockchain: ${transferDetails.blockchain === "SOL" ? "Solana Devnet" : "Ethereum Sepolia"}</div>
                                ${circleTransferId ? `<div style="margin-top: 8px;">Circle Transfer ID: ${circleTransferId}</div>` : ''}
                                <div id="tx-status-${transferId}">
                                    ${txHash && txHash !== 'pending' ? `
                                        <div style="margin-top: 8px;">TX: ${txHash.slice(0, 20)}...</div>
                                        <div style="margin-top: 8px;">
                                            <a href="${explorerUrl}" 
                                               target="_blank" 
                                               class="explorer-link"
                                               style="color: #8B9AFF; text-decoration: underline; font-weight: 600;">
                                               View on ${explorerName} →
                                            </a>
                                        </div>
                                    ` : `
                                        <div style="margin-top: 12px; padding: 10px; background: rgba(251, 191, 36, 0.1); border-radius: 6px;">
                                            <div style="color: #fbbf24; font-weight: 500;">⏳ Transaction Broadcasting...</div>
                                            <div style="font-size: 12px; margin-top: 4px;">
                                                Circle is processing your transfer. The blockchain transaction hash will appear here once the transfer is broadcast to the ${transferDetails.blockchain === 'SOL' ? 'Solana' : 'Ethereum'} network.
                                            </div>
                                            ${circleTransferId ? `<div style="font-size: 11px; margin-top: 8px; color: #888;">
                                                Transfer ID: ${circleTransferId}
                                            </div>` : ''}
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    if (resultDiv) {
                        resultDiv.innerHTML = detailsHtml;
                    }
                    
                    // Start polling if we don't have a transaction hash yet
                    if ((!txHash || txHash === 'pending') && circleTransferId && circleTransferId !== 'pending') {
                        debug(`Starting polling for direct transfer ${transferId}`);
                        pollDirectTransferStatus(circleTransferId, transferId, transferDetails.blockchain || "ETH");
                    }
                }
            } catch (error) {
                console.error('Direct transfer error:', error);
                
                // Check for rate limit error
                if (error.message && error.message.includes('rate limit')) {
                    // Update card with rate limit message
                    const card = document.getElementById(`card-${transferId}`);
                    if (card) {
                        const statusMessage = card.querySelector('.status-message');
                        if (statusMessage) {
                            statusMessage.innerHTML = `
                                <div style="color: #fbbf24;">
                                    <strong>⏸️ Rate limit reached</strong><br>
                                    <span style="font-size: 12px;">Circle API is temporarily limiting requests. Your transfer is queued and will process shortly.</span>
                                </div>
                            `;
                        }
                    }
                    return;
                }
                
                // Update card with error
                const card = document.getElementById(`card-${transferId}`);
                if (card) {
                    const statusDot = card.querySelector('.status-dot');
                    const statusText = card.querySelector('.status-text');
                    const statusMessage = card.querySelector('.status-message');
                    const resultDiv = document.getElementById(`transfer-result-${transferId}`);
                    
                    if (statusDot) {
                        statusDot.style.background = '#ef4444';
                        statusDot.style.animation = 'none';
                    }
                    if (statusText) {
                        statusText.textContent = 'Failed';
                        statusText.style.color = '#ef4444';
                    }
                    if (statusMessage) {
                        statusMessage.textContent = `Transfer failed: ${error.message}`;
                        statusMessage.style.color = '#ef4444';
                    }
                    
                    // Add more detailed error info
                    const errorDetailsHtml = `
                        <div style="margin-top: 20px; padding: 16px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                            <div style="font-weight: 600; color: #ef4444; margin-bottom: 8px;">❌ Transfer Failed</div>
                            <div style="font-size: 13px; color: #a0a0a0;">
                                <div>Error: ${error.message || 'Unknown error'}</div>
                                <div style="margin-top: 8px; font-size: 12px; color: #666;">
                                    This could be due to insufficient balance, invalid recipient address, or Circle API configuration.
                                    Check the console for more details.
                                </div>
                            </div>
                        </div>
                    `;
                    
                    if (resultDiv) {
                        resultDiv.innerHTML = errorDetailsHtml;
                    }
                }
            }
        }
        
        // Separate polling function for direct transfers
        async function pollDirectTransferStatus(transferId, cardId, blockchain) {
            debug(`Starting to poll for direct transfer ${transferId}`);
            
            let pollCount = 0;
            const maxPolls = 30; // Poll for up to 5 minutes (30 * 10 seconds)
            
            const pollInterval = setInterval(async () => {
                pollCount++;
                
                try {
                    // Call backend to check transfer status
                    const response = await fetch('http://localhost:8002/check_transfer_status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ transferId: transferId })
                    });
                    
                    if (response.status === 429) {
                        debug('Rate limit exceeded (429)');
                        showRateLimitMessage(cardId);
                        clearInterval(pollInterval);
                        delete activePolls[transferId];
                        return;
                    }
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Handle rate limit status
                        if (data.status === 'rate_limited') {
                            debug(`Poll ${pollCount}: Rate limited`);
                            showRateLimitMessage(cardId);
                            clearInterval(pollInterval);
                            delete activePolls[transferId];
                            return;
                        }
                        
                        debug(`Poll ${pollCount}: Status = ${data.status}, TxHash = ${data.transactionHash}`);
                        
                        // Check if we have a real transaction hash
                        if (data.transactionHash && data.transactionHash !== 'pending' && data.transactionHash !== 'null') {
                            // Update the UI with the transaction hash
                            updateDirectTransferWithTxHash(cardId, data.transactionHash, blockchain);
                            
                            // Stop polling
                            clearInterval(pollInterval);
                            delete activePolls[transferId];
                            debug(`Got transaction hash for ${transferId}, stopping poll`);
                        } else if (data.status === 'failed' || data.status === 'returned') {
                            // Handle failed transfer
                            updateTransferFailed(cardId, data.errorCode || 'Transfer failed');
                            clearInterval(pollInterval);
                            delete activePolls[transferId];
                        } else if (data.status === 'complete' && !data.transactionHash) {
                            // Sometimes Circle marks as complete but doesn't provide tx hash
                            debug('Transfer complete but no tx hash available');
                            updateTransferCompleteNoHash(cardId, transferId, blockchain);
                            clearInterval(pollInterval);
                            delete activePolls[transferId];
                        }
                    }
                } catch (error) {
                    debug(`Error polling transfer status: ${error.message}`);
                }
                
                // Update the UI with polling status
                if (pollCount % 3 === 0) { // Update every 30 seconds
                    updatePollingStatus(cardId, pollCount * 10);
                }
                
                // Stop polling after max attempts
                if (pollCount >= maxPolls) {
                    clearInterval(pollInterval);
                    delete activePolls[transferId];
                    debug(`Stopped polling for ${transferId} after ${maxPolls} attempts`);
                    updateTransferTimeout(cardId, transferId, blockchain);
                }
            }, 10000); // Poll every 10 seconds
            
            // Store the interval so we can cancel it if needed
            activePolls[transferId] = pollInterval;
        }
        
        // Update function specifically for direct transfers
        function updateDirectTransferWithTxHash(cardId, txHash, blockchain) {
            const card = activeCards[cardId] || document.getElementById(`card-${cardId}`);
            if (!card) {
                debug(`Could not find card ${cardId} to update with tx hash`);
                return;
            }
            
            debug(`Updating direct transfer ${cardId} with txHash: ${txHash}`);
            
            // Find the tx-status div
            const txStatusDiv = card.querySelector(`[id^="tx-status-"]`);
            if (txStatusDiv) {
                // Determine explorer URL based on blockchain
                let explorerUrl = '';
                let explorerName = '';
                
                if (blockchain === 'SOL' || blockchain === 'SOLANA') {
                    explorerUrl = `https://explorer.solana.com/tx/${txHash}?cluster=devnet`;
                    explorerName = 'Solana Explorer';
                } else {
                    explorerUrl = `https://sepolia.etherscan.io/tx/${txHash}`;
                    explorerName = 'Sepolia Etherscan';
                }
                
                txStatusDiv.innerHTML = `
                    <div style="margin-top: 8px;">TX: ${txHash.slice(0, 20)}...</div>
                    <div style="margin-top: 8px;">
                        <a href="${explorerUrl}" 
                           target="_blank" 
                           class="explorer-link"
                           style="color: #8B9AFF; text-decoration: underline; font-weight: 600;">
                           View on ${explorerName} →
                        </a>
                    </div>
                `;
                
                // Update status to show it's complete
                const statusText = card.querySelector('.status-text');
                if (statusText && statusText.textContent !== 'Complete') {
                    statusText.textContent = 'Confirmed';
                    statusText.style.color = '#10b981';
                }
                
                // Add a subtle animation to draw attention
                const detailsDiv = card.querySelector('[style*="rgba(16, 185, 129"]');
                if (detailsDiv) {
                    detailsDiv.style.animation = 'pulse 1s ease-in-out 2';
                }
            }
        }

        function createTransactionCard(proofId, transferDetails = {}) {
            const cardHtml = `
                <div class="transaction-card" id="card-${proofId}">
                    <div class="card-header">
                        <div class="card-title">🔄 Proof and Transaction Status</div>
                        <div class="status-indicator">
                            <span class="status-dot" style="background: #fbbf24; animation: pulse 2s infinite;"></span>
                            <span class="status-text">Initializing...</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="status-message">Starting automated KYC verification and transfer process...</div>
                        <div style="margin-top: 12px; padding: 12px; background: rgba(107, 124, 255, 0.1); border-radius: 8px; font-size: 13px;">
                            <div style="color: #8B9AFF; margin-bottom: 4px;">Transfer Details:</div>
                            <div style="color: #a0a0a0;">From: ${transferDetails.blockchain === "SOL" ? "HsZdbBxZVNzEn4qR9Ebx5XxDSZ136Mu14VlH1nbXGhfG" : "0x82a26a6d847e7e0961ab432b9a5a209e0db41040"} (Circle Wallet)</div>
                            <div style="color: #a0a0a0;">To: ${transferDetails.recipient ? transferDetails.recipient.slice(0,10) + '...' + transferDetails.recipient.slice(-8) : '0x70997970...17dc79C8'}</div>
                            <div style="color: #a0a0a0;">Blockchain: ${transferDetails.blockchain === "SOL" ? "Solana Devnet" : "Ethereum Sepolia"}</div>
                            <div style="color: #a0a0a0;">Amount: ${transferDetails.amount || '0.1'} USDC</div>
                        </div>
                        <div class="progress-steps" style="margin-top: 16px;">
                            <div class="step active" id="step-proof-${proofId}">📝 Generate Proof</div>
                            <div class="step" id="step-verify-${proofId}">✅ Verify Proof</div>
                            <div class="step" id="step-transfer-${proofId}">💸 Execute Transfer</div>
                        </div>
                    </div>
                </div>
            `;
            
            const messages = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message assistant';
            messageEl.innerHTML = cardHtml;
            messages.appendChild(messageEl);
            messages.scrollTop = messages.scrollHeight;
            
            activeCards[proofId] = document.getElementById(`card-${proofId}`);
        }

        function updateProofStatus(data) {
            debug(`Proof status update: ${data.proof_id}`);
            
            if (data.proof_id) {
                proofStates[data.proof_id] = proofStates[data.proof_id] || {};
                if (data.metadata) {
                    proofStates[data.proof_id].functionName = data.metadata.function;
                    proofStates[data.proof_id].arguments = data.metadata.arguments;
                    proofStates[data.proof_id].isCustom = data.metadata.is_custom || false;
                    
                    // Map WASM names back to logical names for display
                    if (data.metadata.function === 'kyc_compliance') {
                        proofStates[data.proof_id].displayFunction = 'prove_kyc';
                    } else if (data.metadata.function === 'ai_content_verification') {
                        proofStates[data.proof_id].displayFunction = 'prove_ai_content';
                    } else if (data.metadata.function === 'depin_location') {
                        proofStates[data.proof_id].displayFunction = 'prove_location';
                    } else if (data.metadata.function === 'prove_custom' || data.metadata.is_custom) {
                        // For custom proofs, try to get the description
                        if (data.metadata.additional_context && data.metadata.additional_context.custom_description) {
                            const customDesc = data.metadata.additional_context.custom_description;
                            if (customDesc === "prime number check") {
                                proofStates[data.proof_id].displayFunction = 'prime_check';
                            } else if (customDesc === "Collatz conjecture computation") {
                                proofStates[data.proof_id].displayFunction = 'collatz_steps';
                            } else if (customDesc === "digital root calculation") {
                                proofStates[data.proof_id].displayFunction = 'digital_root';
                            } else {
                                proofStates[data.proof_id].displayFunction = 'custom_proof';
                            }
                        } else {
                            proofStates[data.proof_id].displayFunction = 'custom_proof';
                        }
                    } else {
                        proofStates[data.proof_id].displayFunction = data.metadata.function;
                    }
                }
            }
            
            const card = activeCards[data.proof_id];
            if (card) {
                const statusText = card.querySelector('.status-text');
                const statusMessage = card.querySelector('.status-message');
                if (statusText) statusText.textContent = 'Generating Proof...';
                if (statusMessage) statusMessage.textContent = data.message || 'Generating zero-knowledge proof...';
            } else {
                createProofCard(data.proof_id, 'generating');
            }
        }

        function createProofCard(proofId, status) {
            const proofState = proofStates[proofId] || {};
            const functionName = proofState.displayFunction || proofState.functionName || 'Unknown';
            
            const cardHtml = `
                <div class="proof-card" id="card-${proofId}">
                    <div class="card-header">
                        <div class="card-title">🔐 Zero-Knowledge Proof</div>
                        <div class="status-badge ${status}">${status.toUpperCase()}</div>
                    </div>
                    <div class="card-content">
                        <div class="status-message">Generating zero-knowledge proof...</div>
                        <div class="proof-metrics" style="margin-top: 16px;">
                            <div class="metric">
                                <span class="metric-label">Function:</span>
                                <span class="metric-value">${functionName}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Step Size:</span>
                                <span class="metric-value">50</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Status:</span>
                                <span class="metric-value">Computing...</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const messages = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message assistant';
            messageEl.innerHTML = cardHtml;
            messages.appendChild(messageEl);
            messages.scrollTop = messages.scrollHeight;
            
            activeCards[proofId] = document.getElementById(`card-${proofId}`);
            proofStates[proofId] = proofStates[proofId] || {};
        }

        function createVerificationCard(proofId) {
            const proofState = proofStates[proofId] || {};
            const functionName = proofState.displayFunction || 'Unknown';
            
            const cardHtml = `
                <div class="verification-card" id="verify-card-${proofId}">
                    <div class="card-header">
                        <div class="card-title">✅ Proof Verification</div>
                        <div class="status-badge verifying">VERIFYING</div>
                    </div>
                    <div class="card-content">
                        <div class="status-message">Verifying proof validity...</div>
                        <div class="proof-metrics" style="display: none;">
                            <div class="metric">
                                <span class="metric-label">Proof ID:</span>
                                <span class="metric-value" style="font-family: monospace;">${proofId}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Function:</span>
                                <span class="metric-value">${functionName}</span>
                            </div>
                            <div class="metric" id="verify-time-${proofId}" style="display: none;">
                                <span class="metric-label">Time:</span>
                                <span class="metric-value">0s</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const messages = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message assistant';
            messageEl.innerHTML = cardHtml;
            messages.appendChild(messageEl);
            messages.scrollTop = messages.scrollHeight;
            
            return document.getElementById(`verify-card-${proofId}`);
        }

        function handleProofComplete(data) {
            debug(`Proof complete: ${data.proof_id}`);
            
            // Ensure we have the function name stored
            if (data.proof_id) {
                const existingState = proofStates[data.proof_id] || {};
                
                // Preserve the function name from earlier status updates
                if (data.metadata && data.metadata.function) {
                    existingState.functionName = data.metadata.function;
                    existingState.arguments = data.metadata.arguments;
                    existingState.isCustom = data.metadata.is_custom || false;
                    
                    // For custom proofs, get the description from metadata
                    if (data.metadata.is_custom && data.metadata.additional_context) {
                        const customDesc = data.metadata.additional_context.custom_description;
                        if (customDesc === "prime number check") {
                            existingState.displayFunction = 'prime_check';
                        } else if (customDesc === "Collatz conjecture computation") {
                            existingState.displayFunction = 'collatz_steps';
                        } else if (customDesc === "digital root calculation") {
                            existingState.displayFunction = 'digital_root';
                        } else {
                            existingState.displayFunction = 'custom_proof';
                        }
                    }
                }
                
                // Also check if function was stored during updateProofStatus
                proofStates[data.proof_id] = existingState;
                debug(`Stored function for ${data.proof_id}: ${existingState.functionName}`);
            }
            
            const card = activeCards[data.proof_id];
            if (card) {
                const statusBadge = card.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.textContent = 'COMPLETE';
                    statusBadge.className = 'status-badge complete';
                }
                
                if (card.classList.contains('transaction-card')) {
                    const statusText = card.querySelector('.status-text');
                    const statusMessage = card.querySelector('.status-message');
                    const proofStep = document.getElementById(`step-proof-${data.proof_id}`);
                    
                    if (statusText) statusText.textContent = 'Proof Generated';
                    if (statusMessage) statusMessage.textContent = 'KYC proof generated successfully. Verifying...';
                    if (proofStep) {
                        proofStep.classList.remove('active');
                        proofStep.classList.add('complete');
                        proofStep.textContent = '✅ Proof Generated';
                    }
                    
                    const verifyStep = document.getElementById(`step-verify-${data.proof_id}`);
                    if (verifyStep) {
                        verifyStep.classList.add('active');
                    }
                } else {
                    const metricsHtml = `
                        <div class="proof-metrics">
                            <div class="metric">
                                <span class="metric-label">Time:</span>
                                <span class="metric-value">${Math.round((data.metrics?.time_ms || 0) / 1000)}s</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Size:</span>
                                <span class="metric-value">${data.metrics ? (data.metrics.proof_size / (1024 * 1024)).toFixed(1) : 0}MB</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Function:</span>
                                <span class="metric-value">${proofStates[data.proof_id]?.displayFunction || 'Unknown'}</span>
                            </div>
                        </div>
                    `;
                    
                    const actionsHtml = `
                        <div class="card-actions">
                            <button class="action-btn" onclick="sendMessage('verify proof ${data.proof_id}')">✅ Verify Proof</button>
                            ${!proofStates[data.proof_id]?.isCustom ? `
                                <button class="action-btn" onclick="showCProgram('${data.proof_id}')">📄 C Program</button>
                                <button class="action-btn" onclick="showWasmFile('${data.proof_id}')">⚙️ WASM Program</button>
                            ` : ''}
                            <button class="action-btn" onclick="copyToClipboard('${data.proof_id}')">📋 Copy ID</button>
                        </div>
                    `;
                    
                    const content = card.querySelector('.card-content');
                    content.innerHTML = metricsHtml + actionsHtml;
                }
            }
        }

        function handleProofError(data) {
            debug(`Proof error: ${data.proof_id} - ${data.error}`);
            const card = activeCards[data.proof_id];
            if (card) {
                const statusBadge = card.querySelector('.status-badge');
                const statusText = card.querySelector('.status-text');
                const statusMessage = card.querySelector('.status-message');
                
                if (statusBadge) {
                    statusBadge.textContent = 'ERROR';
                    statusBadge.className = 'status-badge error';
                }
                if (statusText) {
                    statusText.textContent = 'Error';
                    statusText.style.color = '#ef4444';
                }
                if (statusMessage) {
                    statusMessage.textContent = data.error || 'An error occurred during proof generation';
                    statusMessage.style.color = '#ef4444';
                }
            } else {
                addMessage(`❌ Proof Error: ${data.error}`, 'assistant');
            }
        }

        function updateVerificationStatus(data) {
            // Start timing the verification
            verificationTimes[data.proof_id] = Date.now();
            
            const card = activeCards[data.proof_id];
            if (card && card.classList.contains('transaction-card')) {
                const statusText = card.querySelector('.status-text');
                const statusMessage = card.querySelector('.status-message');
                if (statusText) statusText.textContent = 'Verifying...';
                if (statusMessage) statusMessage.textContent = data.message || 'Verifying proof validity...';
            } else {
                // Create a verification card if it doesn't exist
                const verifyCard = createVerificationCard(data.proof_id);
                activeCards[`verify-${data.proof_id}`] = verifyCard;
            }
        }

        function handleVerificationComplete(data) {
            debug(`Verification complete: ${data.proof_id} - ${data.result}`);
            
            // Calculate verification time
            const verificationTime = verificationTimes[data.proof_id] ? 
                ((Date.now() - verificationTimes[data.proof_id]) / 1000).toFixed(1) : '< 1';
            
            const card = activeCards[data.proof_id];
            const verifyCard = activeCards[`verify-${data.proof_id}`];
            
            if (data.result === 'VALID') {
                if (card && card.classList.contains('transaction-card')) {
                    const verifyStep = document.getElementById(`step-verify-${data.proof_id}`);
                    if (verifyStep) {
                        verifyStep.classList.remove('active');
                        verifyStep.classList.add('complete');
                        verifyStep.textContent = '✅ Proof Verified';
                    }
                    
                    const transferStep = document.getElementById(`step-transfer-${data.proof_id}`);
                    if (transferStep) {
                        transferStep.classList.add('active');
                    }
                    
                    const statusText = card.querySelector('.status-text');
                    const statusMessage = card.querySelector('.status-message');
                    if (statusText) statusText.textContent = 'Proof Verified';
                    if (statusMessage) statusMessage.textContent = 'KYC verification successful. Initiating transfer...';
                } else if (verifyCard) {
                    // Update verification card
                    const statusBadge = verifyCard.querySelector('.status-badge');
                    const statusMessage = verifyCard.querySelector('.status-message');
                    const metricsDiv = verifyCard.querySelector('.proof-metrics');
                    const timeMetric = document.getElementById(`verify-time-${data.proof_id}`);
                    
                    if (statusBadge) {
                        statusBadge.textContent = 'VERIFIED';
                        statusBadge.className = 'status-badge verified';
                    }
                    if (statusMessage) {
                        statusMessage.textContent = 'Proof verification successful!';
                        statusMessage.style.color = '#10b981';
                    }
                    if (metricsDiv) {
                        metricsDiv.style.display = 'flex';
                    }
                    if (timeMetric) {
                        timeMetric.style.display = 'flex';
                        timeMetric.querySelector('.metric-value').textContent = `${verificationTime}s`;
                    }
                } else {
                    addMessage('✅ Proof verification: **VALID**', 'assistant');
                }
            } else {
                if (verifyCard) {
                    const statusBadge = verifyCard.querySelector('.status-badge');
                    const statusMessage = verifyCard.querySelector('.status-message');
                    
                    if (statusBadge) {
                        statusBadge.textContent = 'INVALID';
                        statusBadge.className = 'status-badge error';
                    }
                    if (statusMessage) {
                        statusMessage.textContent = 'Proof verification failed';
                        statusMessage.style.color = '#ef4444';
                    }
                } else if (card) {
                    const statusText = card.querySelector('.status-text');
                    const statusMessage = card.querySelector('.status-message');
                    if (statusText) {
                        statusText.textContent = 'Verification Failed';
                        statusText.style.color = '#ef4444';
                    }
                    if (statusMessage) {
                        statusMessage.textContent = 'Proof verification failed';
                        statusMessage.style.color = '#ef4444';
                    }
                } else {
                    addMessage('❌ Proof verification: **INVALID**', 'assistant');
                }
            }
            
            // Clean up timing
            delete verificationTimes[data.proof_id];
        }

        function updateTransferStatus(data) {
            const card = activeCards[data.proof_id];
            if (card) {
                const statusText = card.querySelector('.status-text');
                const statusMessage = card.querySelector('.status-message');
                if (statusText) statusText.textContent = 'Executing Transfer...';
                if (statusMessage) statusMessage.textContent = data.message || 'Executing USDC transfer via Circle...';
            }
        }

        function handleTransferComplete(data) {
            debug(`Transfer complete: ${data.proof_id}`);
            const card = activeCards[data.proof_id];
            if (card) {
                const transferStep = document.getElementById(`step-transfer-${data.proof_id}`);
                if (transferStep) {
                    transferStep.classList.remove('active');
                    transferStep.classList.add('complete');
                    transferStep.textContent = '✅ Transfer Complete';
                }
                
                const statusDot = card.querySelector('.status-dot');
                const statusText = card.querySelector('.status-text');
                const content = card.querySelector('.card-content');
                
                if (statusDot) statusDot.style.background = '#10b981';
                if (statusText) {
                    statusText.textContent = 'Complete';
                    statusText.style.color = '#10b981';
                }
                
                const txDetails = data.result;
                const blockchain = txDetails.blockchain || 'ETH';
                
                // Get transaction hash - Circle may not have it immediately
                const txHash = txDetails.transactionHash || txDetails.txHash || txDetails.hash;
                const transferId = txDetails.transferId || txDetails.circleTransferId || txDetails.id;
                const hasTxHash = txHash && txHash !== 'pending';
                
                // Determine the correct explorer URL based on blockchain
                let explorerUrl = '';
                let explorerName = '';
                
                if (hasTxHash) {
                    if (blockchain === 'SOL') {
                        explorerUrl = `https://explorer.solana.com/tx/${txHash}?cluster=devnet`;
                        explorerName = 'Solana Explorer';
                    } else {
                        explorerUrl = `https://sepolia.etherscan.io/tx/${txHash}`;
                        explorerName = 'Sepolia Etherscan';
                    }
                }
                
                const detailsHtml = `
                    <div style="margin-top: 20px; padding: 16px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                        <div style="font-weight: 600; color: #10b981; margin-bottom: 8px;">✅ Transfer Initiated!</div>
                        <div style="font-size: 13px; color: #a0a0a0;">
                            <div>Amount: ${txDetails.amount || '0.1'} USDC</div>
                            <div>From: ${txDetails.from || 'Circle Wallet'}</div>
                            <div>To: ${txDetails.recipient || 'Unknown'}</div>
                            <div>Blockchain: ${blockchain === 'SOL' ? 'Solana Devnet' : 'Ethereum Sepolia'}</div>
                            ${transferId ? `<div style="margin-top: 8px;">Circle Transfer ID: ${transferId}</div>` : ''}
                            ${hasTxHash ? `
                                <div style="margin-top: 8px;">TX: ${txHash}</div>
                                <div style="margin-top: 8px;">
                                    <a href="${explorerUrl}" 
                                       target="_blank" 
                                       style="color: #8B9AFF; text-decoration: underline; font-weight: 600;">
                                       View on ${explorerName} →
                                    </a>
                                </div>
                            ` : `
                                <div style="margin-top: 12px; padding: 10px; background: rgba(251, 191, 36, 0.1); border-radius: 6px;">
                                    <div style="color: #fbbf24; font-weight: 500;">⏳ Transaction Broadcasting...</div>
                                    <div style="font-size: 12px; margin-top: 4px;">
                                        Circle is processing your transfer. The blockchain transaction hash will appear here once the transfer is broadcast to the ${blockchain === 'SOL' ? 'Solana' : 'Ethereum'} network.
                                    </div>
                                    ${transferId ? `<div style="font-size: 11px; margin-top: 8px; color: #888;">
                                        Transfer ID: ${transferId}
                                    </div>` : ''}
                                </div>
                            `}
                        </div>
                    </div>
                `;
                
                content.innerHTML += detailsHtml;
                
                // Start polling if we don't have a transaction hash yet
                if (!hasTxHash && transferId && transferId !== 'pending') {
                    pollTransferStatus(transferId, data.proof_id, blockchain);
                }
            }
        }

        // Function to poll for transfer status
        async function pollTransferStatus(transferId, proofId, blockchain) {
            debug(`Starting to poll for transfer ${transferId}`);
            
            let pollCount = 0;
            const maxPolls = 30; // Poll for up to 5 minutes (30 * 10 seconds)
            
            const pollInterval = setInterval(async () => {
                pollCount++;
                
                try {
                    // Call backend to check transfer status
                    const response = await fetch('http://localhost:8002/check_transfer_status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ transferId: transferId })
                    });
                    
                    if (response.status === 429) {
                        debug('Rate limit exceeded (429)');
                        showRateLimitMessage(proofId);
                        // Stop polling for this transfer
                        delete activePolls[transferId];
                        return;
                    }
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Handle rate limit status
                        if (data.status === 'rate_limited') {
                            debug(`Poll ${pollCount}: Rate limited`);
                            showRateLimitMessage(proofId);
                            // Back off more aggressively
                            pollDelay = 60000; // Wait 60 seconds
                            setTimeout(doPoll, pollDelay);
                            return;
                        }
                        debug(`Poll ${pollCount}: Status = ${data.status}, TxHash = ${data.transactionHash}`);
                        
                        // Check if we have a real transaction hash
                        if (data.transactionHash && data.transactionHash !== 'pending') {
                            // Update the UI with the transaction hash
                            updateTransferWithTxHash(proofId, data.transactionHash, blockchain);
                            
                            // Stop polling
                            clearInterval(pollInterval);
                            delete activePolls[transferId];
                            debug(`Got transaction hash for ${transferId}, stopping poll`);
                        } else if (data.status === 'failed' || data.status === 'returned') {
                            // Handle failed transfer
                            updateTransferFailed(proofId, data.errorCode || 'Transfer failed');
                            clearInterval(pollInterval);
                            delete activePolls[transferId];
                        } else if (data.status === 'complete' && !data.transactionHash) {
                            // Sometimes Circle marks as complete but doesn't provide tx hash
                            debug('Transfer complete but no tx hash available');
                            updateTransferCompleteNoHash(proofId, transferId, blockchain);
                            clearInterval(pollInterval);
                            delete activePolls[transferId];
                        }
                    }
                } catch (error) {
                    debug(`Error polling transfer status: ${error.message}`);
                }
                
                // Update the UI with polling status
                if (pollCount % 3 === 0) { // Update every 30 seconds
                    updatePollingStatus(proofId, pollCount * 10);
                }
                
                // Stop polling after max attempts
                if (pollCount >= maxPolls) {
                    clearInterval(pollInterval);
                    delete activePolls[transferId];
                    debug(`Stopped polling for ${transferId} after ${maxPolls} attempts`);
                    updateTransferTimeout(proofId, transferId, blockchain);
                }
            }, 10000); // Poll every 10 seconds
            
            // Store the interval so we can cancel it if needed
            activePolls[transferId] = pollInterval;
        }

        // Function to update UI with transaction hash
        function updateTransferWithTxHash(proofId, txHash, blockchain) {
            const card = activeCards[proofId];
            if (!card) return;
            
            debug(`Updating transfer ${proofId} with txHash: ${txHash}`);
            
            // Find the transfer details section more reliably
            const content = card.querySelector('.card-content');
            const detailsSections = content.querySelectorAll('div[style*="background: rgba(16, 185, 129"]');
            
            let existingDetails = null;
            for (let section of detailsSections) {
                if (section.textContent.includes('Transfer Initiated') || section.textContent.includes('Transfer Successful')) {
                    existingDetails = section;
                    break;
                }
            }
            
            if (existingDetails) {
                // Determine explorer URL based on blockchain
                let explorerUrl = '';
                let explorerName = '';
                
                if (blockchain === 'SOL') {
                    explorerUrl = `https://explorer.solana.com/tx/${txHash}?cluster=devnet`;
                    explorerName = 'Solana Explorer';
                } else {
                    explorerUrl = `https://sepolia.etherscan.io/tx/${txHash}`;
                    explorerName = 'Sepolia Etherscan';
                }
                
                // Find the transaction broadcasting div and replace it
                const broadcastDiv = existingDetails.querySelector('div[style*="rgba(251, 191, 36, 0.1)"]');
                if (broadcastDiv) {
                    broadcastDiv.innerHTML = `
                        <div style="color: #10b981; font-weight: 500;">✅ Transaction Confirmed!</div>
                        <div style="font-size: 12px; margin-top: 4px;">
                            TX: ${txHash}
                        </div>
                        <div style="margin-top: 8px;">
                            <a href="${explorerUrl}" 
                               target="_blank" 
                               style="color: #8B9AFF; text-decoration: underline; font-weight: 600;">
                               View on ${explorerName} →
                            </a>
                        </div>
                    `;
                    
                    // Add a subtle animation to draw attention
                    existingDetails.style.animation = 'pulse 1s ease-in-out 2';
                }
            }
        }

        // Add function to update polling status in UI
        function updatePollingStatus(proofId, secondsElapsed) {
            const card = activeCards[proofId];
            if (!card) return;
            
            const pollingStatus = card.querySelector('div[style*="rgba(251, 191, 36, 0.1)"]');
            if (pollingStatus) {
                const timeDiv = pollingStatus.querySelector('div[style*="typically takes"]');
                if (timeDiv) {
                    timeDiv.innerHTML = `Checking status... (${secondsElapsed}s elapsed). `;
                }
            }
        }

        // Add function for when transfer completes without tx hash
        function updateTransferCompleteNoHash(proofId, transferId, blockchain) {
            const card = activeCards[proofId];
            if (!card) return;
            
            const content = card.querySelector('.card-content');
            const existingDetails = content.querySelector('div[style*="background: rgba(16, 185, 129"]');
            
            if (existingDetails) {
                const pollingDiv = existingDetails.querySelector('div[style*="rgba(251, 191, 36, 0.1)"]');
                if (pollingDiv) {
                    pollingDiv.innerHTML = `
                        <div style="color: #10b981; font-weight: 500;">✅ Transfer Complete</div>
                        <div style="font-size: 12px; margin-top: 4px;">
                            The transfer has been completed by Circle. Transaction details may be available in your Circle dashboard.
                        </div>
                        <div style="font-size: 11px; margin-top: 8px; color: #888;">
                            Circle Transfer ID: ${transferId}
                        </div>
                    `;
                }
            }
        }

        // Add function for timeout scenario
        function updateTransferTimeout(proofId, transferId, blockchain) {
            const card = activeCards[proofId];
            if (!card) return;
            
            const content = card.querySelector('.card-content');
            const existingDetails = content.querySelector('div[style*="background: rgba(16, 185, 129"]');
            
            if (existingDetails) {
                const pollingDiv = existingDetails.querySelector('div[style*="rgba(251, 191, 36, 0.1)"]');
                if (pollingDiv) {
                    pollingDiv.innerHTML = `
                        <div style="color: #fbbf24; font-weight: 500;">⏱️ Status Check Timeout</div>
                        <div style="font-size: 12px; margin-top: 4px;">
                            The transaction is still being processed. You can check the status later using the Circle Transfer ID.
                        </div>
                        <div style="font-size: 11px; margin-top: 8px; color: #888;">
                            Circle Transfer ID: ${transferId}
                        </div>
                    `;
                }
            }
        }

        // Function to handle failed transfers
        function updateTransferFailed(proofId, errorMessage) {
            const card = activeCards[proofId];
            if (!card) return;
            
            const statusDot = card.querySelector('.status-dot');
            const statusText = card.querySelector('.status-text');
            
            if (statusDot) {
                statusDot.style.background = '#ef4444';
                statusDot.style.animation = 'none';
            }
            if (statusText) {
                statusText.textContent = 'Failed';
                statusText.style.color = '#ef4444';
            }
            
            // Update the content with error message
            const content = card.querySelector('.card-content');
            const existingDetails = content.querySelector('div[style*="background: rgba(16, 185, 129, 0.1)"]');
            
            if (existingDetails) {
                existingDetails.style.background = 'rgba(239, 68, 68, 0.1)';
                const titleDiv = existingDetails.querySelector('div[style*="font-weight: 600"]');
                if (titleDiv) {
                    titleDiv.textContent = '❌ Transfer Failed';
                    titleDiv.style.color = '#ef4444';
                }
                
                // Add error message
                const detailsDiv = existingDetails.querySelector('div[style*="font-size: 13px"]');
                if (detailsDiv) {
                    detailsDiv.innerHTML += `
                        <div style="margin-top: 8px; color: #ef4444; font-weight: 500;">
                            Error: ${errorMessage}
                        </div>
                    `;
                }
            }
        }

        function handleTransferError(data) {
            debug(`Transfer error: ${data.proof_id} - ${data.error}`);
            const card = activeCards[data.proof_id];
            if (card) {
                const statusDot = card.querySelector('.status-dot');
                const statusText = card.querySelector('.status-text');
                const statusMessage = card.querySelector('.status-message');
                
                if (statusDot) {
                    statusDot.style.background = '#ef4444';
                    statusDot.style.animation = 'none';
                }
                if (statusText) {
                    statusText.textContent = 'Transfer Failed';
                    statusText.style.color = '#ef4444';
                }
                if (statusMessage) {
                    statusMessage.textContent = data.error || 'Transfer failed';
                    statusMessage.style.color = '#ef4444';
                }
            }
        }
        
        function handleListResponse(data) {
            debug(`List response: ${data.list_type}`);
            
            if (data.proofs && data.proofs.length > 0) {
                // Different columns for Proof History vs Verification History
                const isVerificationHistory = data.list_type === 'verifications';
                
                let tableHtml = '';
                
                if (isVerificationHistory) {
                    // Verification History: Function, Proof ID, Timestamp
                    tableHtml = `
                        <div class="history-table-container">
                            <h3 style="color: #8B9AFF; margin-bottom: 16px; font-size: 16px;">
                                ✅ Verification History
                            </h3>
                            <table class="history-table">
                                <thead>
                                    <tr>
                                        <th>FUNCTION</th>
                                        <th>PROOF ID</th>
                                        <th>TIMESTAMP</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.proofs.map(proof => {
                                        // Format function name for display
                                        let displayFunction = proof.function || 'unknown';
                                        if (displayFunction === 'prove_kyc') displayFunction = 'KYC Compliance';
                                        else if (displayFunction === 'prove_ai_content') displayFunction = 'AI Content';
                                        else if (displayFunction === 'prove_location') displayFunction = 'Location';
                                        else if (displayFunction === 'prove_custom') displayFunction = 'Custom';
                                        else if (displayFunction === 'unknown') displayFunction = 'Unknown';
                                        
                                        return `
                                            <tr>
                                                <td><span class="function-badge">${displayFunction}</span></td>
                                                <td class="proof-id">${proof.proof_id}</td>
                                                <td class="timestamp">${new Date(proof.timestamp * 1000).toLocaleString()}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    // Proof History: Function, Proof ID, Timestamp, Actions
                    tableHtml = `
                        <div class="history-table-container">
                            <h3 style="color: #8B9AFF; margin-bottom: 16px; font-size: 16px;">
                                📋 Proof History
                            </h3>
                            <table class="history-table">
                                <thead>
                                    <tr>
                                        <th>FUNCTION</th>
                                        <th>PROOF ID</th>
                                        <th>TIMESTAMP</th>
                                        <th>ACTIONS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.proofs.map(proof => {
                                        // Format function name for display
                                        let displayFunction = proof.function || 'unknown';
                                        if (displayFunction === 'prove_kyc') displayFunction = 'KYC Compliance';
                                        else if (displayFunction === 'prove_ai_content') displayFunction = 'AI Content';
                                        else if (displayFunction === 'prove_location') displayFunction = 'Location';
                                        else if (displayFunction === 'prove_custom') displayFunction = 'Custom';
                                        else if (displayFunction === 'unknown') displayFunction = 'Unknown';
                                        
                                        return `
                                            <tr>
                                                <td><span class="function-badge">${displayFunction}</span></td>
                                                <td class="proof-id">${proof.proof_id}</td>
                                                <td class="timestamp">${new Date(proof.timestamp * 1000).toLocaleString()}</td>
                                                <td>
                                                    ${proof.verified 
                                                        ? '<span style="color: #10b981;">✓ Verified</span>' 
                                                        : '<a class="action-link" onclick="sendMessage(\'verify proof ' + proof.proof_id + '\')">Verify</a>'
                                                    }
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                const messages = document.getElementById('messages');
                const messageEl = document.createElement('div');
                messageEl.className = 'message assistant';
                messageEl.innerHTML = tableHtml;
                messages.appendChild(messageEl);
                messages.scrollTop = messages.scrollHeight;
            } else {
                addMessage(data.response + '\n\n<em style="color: #666;">No proofs found yet.</em>', 'assistant');
            }
        }
        
        function togglePasteArea() {
            const pasteArea = document.getElementById('paste-area');
            const isHidden = pasteArea.style.display === 'none' || pasteArea.style.display === '';
            pasteArea.style.display = isHidden ? 'flex' : 'none';
            if (isHidden) {
                updateLineNumbers();
            }
        }

        function updateLineNumbers() {
            const textarea = document.getElementById('code-paste');
            const lineNumbers = document.getElementById('line-numbers');
            const lines = textarea.value.split('\n').length;
            
            let lineNumbersHtml = '';
            for (let i = 1; i <= lines; i++) {
                lineNumbersHtml += i + '\n';
            }
            lineNumbers.textContent = lineNumbersHtml;
            
            // Sync scroll
            textarea.onscroll = function() {
                lineNumbers.scrollTop = textarea.scrollTop;
            };
        }

        function processCodePaste() {
            const code = document.getElementById('code-paste').value;
            if (!code.trim()) return alert('Please paste code first.');
            
            // Detect which example this is
            let proofType = "custom proof";
            let cleanType = "custom";
            
            if (code.includes("prime")) {
                proofType = "prime number check";
                cleanType = "prime check";
            } else if (code.includes("collatz") || code.includes("Collatz")) {
                proofType = "Collatz conjecture";
                cleanType = "Collatz steps";
            } else if (code.includes("digital") && code.includes("root")) {
                proofType = "digital root calculation";
                cleanType = "digital root";
            }
            
            // Store that this is a custom proof
            const customProofId = `proof_${Date.now()}_custom`;
            proofStates[customProofId] = {
                functionName: 'prove_custom',
                displayFunction: proofType,
                isCustom: true
            };
            
            // Encode the code
            const encodedCode = btoa(code);
            const message = `prove custom ${encodedCode}`;
            
            // Put the encoded message in the input field
            document.getElementById('user-input').value = message;
            
            // Clear and close
            togglePasteArea();
            document.getElementById('code-paste').value = '';
            
            // Focus on input so user can hit Send
            document.getElementById('user-input').focus();
        }
        
        function loadPasteExample(type) {
            const examples = {
                'simple': `// Prime Number Checker Example
int main() {
    int n = 17;
    if (n <= 1) return 0;
    if (n <= 3) return 1;
    if (n % 2 == 0 || n % 3 == 0) return 0;
    for (int i = 5; i * i <= n; i = i + 6) {
        if (n % i == 0 || n % (i + 2) == 0) return 0;
    }
    return 1;
}`,
                'range': `// Collatz Conjecture Steps
int main() {
    int n = 27;
    int steps = 0;
    while (n != 1 && steps < 1000) {
        if (n % 2 == 0) n = n / 2;
        else n = 3 * n + 1;
        steps++;
    }
    return steps;
}`,
                'hash': `// Digital Root Calculator
int main() {
    int n = 12345;
    if (n == 0) return 0;
    return (n - 1) % 9 + 1;
}`
            };
            document.getElementById('code-paste').value = examples[type];
            updateLineNumbers();
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const code = await file.text();
            
            // Put the encoded code in the input field instead of sending directly
            const encodedCode = btoa(code);
            document.getElementById('user-input').value = `prove custom ${encodedCode}`;
            document.getElementById('user-input').focus();
            
            event.target.value = '';
        }

        function showCProgram(proofId) {
            const card = document.getElementById(`card-${proofId}`);
            if (!card) return;
            
            const existingDisplay = card.querySelector('.inline-code-display');
            if (existingDisplay) {
                existingDisplay.remove();
                return;
            }
            
            const state = proofStates[proofId] || {};
            let cCode = '';
            let fileName = 'program.c';
            
            // Use the stored function name
            const funcName = state.functionName || state.displayFunction;
            debug(`Showing C program for ${proofId}, function: ${funcName}`);
            
            if (funcName === 'prove_kyc' || funcName === 'kyc_compliance') {
                cCode = '// KYC Compliance Verification\n' +
                        '#include <stdint.h>\n\n' +
                        'int32_t main(int32_t wallet_hash, int32_t kyc_approved) {\n' +
                        '    // Privacy-preserving KYC proof\n' +
                        '    // wallet_hash: Hash of wallet address (preserves privacy)\n' +
                        '    // kyc_approved: 1=approved by Circle, 0=rejected\n' +
                        '    \n' +
                        '    int32_t base_computation = wallet_hash * 31;\n' +
                        '    int32_t kyc_factor = kyc_approved * 1000;\n' +
                        '    int32_t combined = base_computation + kyc_factor;\n' +
                        '    \n' +
                        '    // Modular arithmetic for zero-knowledge property\n' +
                        '    int32_t proof_result = combined % 999983;\n' +
                        '    \n' +
                        '    return proof_result;\n' +
                        '}';
                fileName = 'prove_kyc.c';
            } else if (funcName === 'prove_location' || funcName === 'depin_location') {
                cCode = '// Location Verification for DePIN\n' +
                        'int main(int packed_input) {\n' +
                        '    // Extract components from packed input\n' +
                        '    int lat = (packed_input >> 24) & 0xFF;      // Normalized latitude\n' +
                        '    int lon = (packed_input >> 16) & 0xFF;      // Normalized longitude\n' +
                        '    int device_id = packed_input & 0xFFFF;      // Device ID\n' +
                        '    \n' +
                        '    // Device ID validation (prevent spoofing)\n' +
                        '    if (device_id <= 100 || device_id >= 65000) return 0;\n' +
                        '    \n' +
                        '    // San Francisco bounds (lat: 37.7-37.8, lon: -122.5 to -122.4)\n' +
                        '    if (lat >= 95 && lat <= 98 && lon >= 120 && lon <= 125) return 1;\n' +
                        '    \n' +
                        '    // New York bounds (lat: 40.7-40.8, lon: -74.1 to -74.0)\n' +
                        '    if (lat >= 102 && lat <= 105 && lon >= 180 && lon <= 185) return 2;\n' +
                        '    \n' +
                        '    // London bounds (lat: 51.4-51.6, lon: -0.2 to 0.1)\n' +
                        '    if (lat >= 128 && lat <= 132 && lon >= 240 && lon <= 245) return 3;\n' +
                        '    \n' +
                        '    return 0; // Not in any supported city\n' +
                        '}';
                fileName = 'prove_location.c';
            } else if (funcName === 'prove_ai_content' || funcName === 'ai_content_verification') {
                cCode = '// AI Content Authenticity Verification\n' +
                        '#include <stdint.h>\n\n' +
                        'int32_t main(int32_t content_hash, int32_t provider_signature) {\n' +
                        '    // Check authorized AI providers\n' +
                        '    // 1000 = OpenAI\n' +
                        '    // 2000 = Anthropic\n' +
                        '    if (provider_signature != 1000 && provider_signature != 2000) {\n' +
                        '        return 0; // Unauthorized provider\n' +
                        '    }\n' +
                        '    \n' +
                        '    // Validate content hash (must be non-trivial)\n' +
                        '    if (content_hash <= 1000) {\n' +
                        '        return 0; // Invalid content\n' +
                        '    }\n' +
                        '    \n' +
                        '    return 1; // Valid AI-generated content\n' +
                        '}';
                fileName = 'prove_ai_content.c';
            } else if (state.isCustom) {
                // For custom proofs, show generic custom code
                cCode = '// Custom Proof Program\n' +
                        'int main(int input) {\n' +
                        '    // Custom proof logic\n' +
                        '    // This would be your actual C code\n' +
                        '    return input; // Example computation\n' +
                        '}';
                fileName = 'custom_proof.c';
            } else {
                cCode = '// Custom Proof Program\n' +
                        'int main() {\n' +
                        '    // Custom proof logic\n' +
                        '    return 1;\n' +
                        '}';
                fileName = 'custom_proof.c';
            }
            
            const codeDisplay = document.createElement('div');
            codeDisplay.className = 'inline-code-display';
            codeDisplay.innerHTML = `
                <div style="margin-top:20px;padding:20px;background:rgba(17,17,17,0.8);border:1px solid rgba(107,124,255,0.2);border-radius:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <span style="font-size:20px;">📄</span>
                            <h3 style="margin:0;color:#6B7CFF;font-size:16px;font-weight:600;">${fileName}</h3>
                        </div>
                        <button onclick="this.closest('.inline-code-display').remove()" style="background:none;border:none;color:#666;font-size:24px;cursor:pointer;">×</button>
                    </div>
                    <pre style="background:rgba(0,0,0,0.5);color:#fff;padding:20px;border-radius:8px;overflow-x:auto;font-family:monospace;font-size:13px;line-height:1.6;margin:0;"><code class="language-c">${escapeHtml(cCode)}</code></pre>
                </div>
            `;
            card.appendChild(codeDisplay);
            
            if (typeof Prism !== 'undefined') {
                Prism.highlightAllUnder(codeDisplay);
            }
        }

        function showWasmFile(proofId) {
            const card = document.getElementById(`card-${proofId}`);
            if (!card) return;
            
            const existingDisplay = card.querySelector('.inline-code-display');
            if (existingDisplay) {
                existingDisplay.remove();
                return;
            }
            
            const state = proofStates[proofId] || {};
            let watCode = '';
            let fileName = 'program.wasm';
            
            // Use the stored function name
            const funcName = state.functionName || state.displayFunction;
            
            if (funcName === 'prove_kyc' || funcName === 'kyc_compliance') {
                watCode = '(module\n' +
                          '  ;; KYC Compliance Verification WASM\n' +
                          '  ;; Proves wallet KYC status without revealing identity\n' +
                          '  \n' +
                          '  (func $main (export "main") (param $wallet_hash i32) (param $kyc_status i32) (result i32)\n' +
                          '    ;; Privacy-preserving computation\n' +
                          '    local.get $wallet_hash\n' +
                          '    i32.const 31\n' +
                          '    i32.mul\n' +
                          '    local.get $kyc_status\n' +
                          '    i32.const 1000\n' +
                          '    i32.mul\n' +
                          '    i32.add\n' +
                          '    i32.const 999983\n' +
                          '    i32.rem_s\n' +
                          '  )\n' +
                          ')';
                fileName = 'kyc_compliance.wasm';
            } else if (funcName === 'prove_location' || funcName === 'depin_location') {
                watCode = '(module\n' +
                          '  ;; DePIN Location Proof WASM\n' +
                          '  ;; Verifies device location without revealing coordinates\n' +
                          '  \n' +
                          '  (func $main (export "main") (param $packed_input i32) (result i32)\n' +
                          '    local $lat i32\n' +
                          '    local $lon i32\n' +
                          '    local $device_id i32\n' +
                          '    \n' +
                          '    ;; Extract latitude\n' +
                          '    local.get $packed_input\n' +
                          '    i32.const 24\n' +
                          '    i32.shr_u\n' +
                          '    i32.const 0xFF\n' +
                          '    i32.and\n' +
                          '    local.set $lat\n' +
                          '    \n' +
                          '    ;; Extract longitude\n' +
                          '    local.get $packed_input\n' +
                          '    i32.const 16\n' +
                          '    i32.shr_u\n' +
                          '    i32.const 0xFF\n' +
                          '    i32.and\n' +
                          '    local.set $lon\n' +
                          '    \n' +
                          '    ;; Check San Francisco bounds\n' +
                          '    local.get $lat\n' +
                          '    i32.const 95\n' +
                          '    i32.ge_u\n' +
                          '    local.get $lat\n' +
                          '    i32.const 98\n' +
                          '    i32.le_u\n' +
                          '    i32.and\n' +
                          '    local.get $lon\n' +
                          '    i32.const 120\n' +
                          '    i32.ge_u\n' +
                          '    i32.and\n' +
                          '    local.get $lon\n' +
                          '    i32.const 125\n' +
                          '    i32.le_u\n' +
                          '    i32.and\n' +
                          '    if (result i32)\n' +
                          '      i32.const 1  ;; San Francisco\n' +
                          '    else\n' +
                          '      i32.const 0  ;; Not in SF\n' +
                          '    end\n' +
                          '  )\n' +
                          ')';
                fileName = 'depin_location.wasm';
            } else if (funcName === 'prove_ai_content' || funcName === 'ai_content_verification') {
                watCode = '(module\n' +
                          '  ;; AI Content Verification WASM\n' +
                          '  ;; Verifies content authenticity from authorized AI providers\n' +
                          '  \n' +
                          '  (func $main (export "main") (param $content_hash i32) (param $provider i32) (result i32)\n' +
                          '    ;; Check if provider is OpenAI (1000) or Anthropic (2000)\n' +
                          '    local.get $provider\n' +
                          '    i32.const 1000\n' +
                          '    i32.eq\n' +
                          '    local.get $provider\n' +
                          '    i32.const 2000\n' +
                          '    i32.eq\n' +
                          '    i32.or\n' +
                          '    \n' +
                          '    ;; Check if content hash is valid (> 1000)\n' +
                          '    local.get $content_hash\n' +
                          '    i32.const 1000\n' +
                          '    i32.gt_s\n' +
                          '    \n' +
                          '    ;; Both conditions must be true\n' +
                          '    i32.and\n' +
                          '  )\n' +
                          ')';
                fileName = 'ai_content_verification.wasm';
            } else if (state.isCustom) {
                // For custom proofs, show a generic custom WASM
                watCode = '(module\n' +
                          '  ;; Custom Proof WASM\n' +
                          '  ;; This would be your compiled custom proof\n' +
                          '  (func $main (export "main") (param $input i32) (result i32)\n' +
                          '    ;; Custom computation\n' +
                          '    local.get $input\n' +
                          '  )\n' +
                          ')';
                          
                if (state.displayFunction === 'prime_check') {
                    fileName = 'prime_checker.wasm';
                } else if (state.displayFunction === 'collatz_steps') {
                    fileName = 'collatz.wasm';
                } else if (state.displayFunction === 'digital_root') {
                    fileName = 'digital_root.wasm';
                } else {
                    fileName = 'custom_proof.wasm';
                }
            } else {
                watCode = '(module\n' +
                          '  ;; Custom Proof WASM\n' +
                          '  (func $main (export "main") (result i32)\n' +
                          '    i32.const 1\n' +
                          '  )\n' +
                          ')';
                fileName = 'custom_proof.wasm';
            }
            
            const codeDisplay = document.createElement('div');
            codeDisplay.className = 'inline-code-display';
            codeDisplay.innerHTML = `
                <div style="margin-top:20px;padding:20px;background:rgba(17,17,17,0.8);border:1px solid rgba(107,124,255,0.2);border-radius:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <span style="font-size:20px;">⚙️</span>
                            <h3 style="margin:0;color:#6B7CFF;font-size:16px;font-weight:600;">${fileName}</h3>
                        </div>
                        <button onclick="this.closest('.inline-code-display').remove()" style="background:none;border:none;color:#666;font-size:24px;cursor:pointer;">×</button>
                    </div>
                    <pre style="background:rgba(0,0,0,0.5);color:#fff;padding:20px;border-radius:8px;overflow-x:auto;font-family:monospace;font-size:13px;line-height:1.6;margin:0;"><code class="language-wasm">${escapeHtml(watCode)}</code></pre>
                </div>
            `;
            card.appendChild(codeDisplay);
            
            if (typeof Prism !== 'undefined') {
                Prism.highlightAllUnder(codeDisplay);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #6B7CFF 0%, #4A5A8A 100%);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    font-size: 13px;
                    font-weight: 600;
                    box-shadow: 0 4px 12px rgba(107, 124, 255, 0.4);
                    z-index: 10000;
                    animation: slideIn 0.3s ease-out;
                `;
                toast.textContent = '✓ Copied to clipboard';
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => toast.remove(), 300);
                }, 2000);
            });
        }

        // Add keyboard shortcut to toggle debug console
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                debugMode = !debugMode;
                document.getElementById('debug-console').style.display = debugMode ? 'block' : 'none';
                debug(`Debug mode ${debugMode ? 'enabled' : 'disabled'}`);
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            debug('DOM loaded, initializing WebSocket connection...');
            connect();
            
            document.getElementById('send-button').addEventListener('click', () => sendMessage());
            document.getElementById('user-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            document.querySelectorAll('.example-item').forEach(item => {
                item.addEventListener('click', () => {
                    // Just populate the input field, don't send
                    const exampleText = item.getAttribute('data-example');
                    document.getElementById('user-input').value = exampleText;
                    document.getElementById('user-input').focus();
                });
            });
            
            // Show debug hint
            console.log('💡 Press Ctrl+Shift+D to toggle debug console');
        });

        // Clean up any active polls when page unloads
        window.addEventListener('beforeunload', () => {
            Object.values(activePolls).forEach(interval => clearInterval(interval));
        });
    </script>
</body>
</html>
